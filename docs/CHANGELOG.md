# Changelog

All notable changes to Draehi will be documented in this file.

Format based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

---

## [Unreleased]

### Added
- Initial project scaffolding with Next.js 16, TypeScript, Tailwind CSS v4
- Comprehensive documentation structure:
  - CLAUDE.md with AI agent instructions (completed with project overview, schema, structure)
  - ROADMAP.md with 7-phase development plan
  - CHANGELOG.md for tracking changes
  - DIRECTORY.md with complete project navigation guide
  - CRUD_GUIDELINES.md for data operations
  - PERFORMANCE_GUIDELINES.md for optimization patterns
- Modular monolith folder structure created:
  - modules/ (auth, workspace, content, git, logseq)
  - components/ (ui, workspace, content, dashboard)
  - lib/ for shared utilities
  - drizzle/ for migrations
- Database schema implementation (Drizzle ORM + PostgreSQL):
  - users table (username/password auth)
  - workspaces table (one per user)
  - git_repositories table (repo tracking)
  - deployment_history table (deployment logs)
  - nodes table (content with namespace hierarchy)
- Core dependencies installed:
  - drizzle-orm, drizzle-kit (database)
  - postgres (PostgreSQL client)
  - zod (validation)
  - bcryptjs (password hashing)
  - iron-session (sessions)
  - clsx, tailwind-merge (styling utilities)
- Database client setup (lib/db.ts)
- Shared utilities (lib/utils.ts, lib/types.ts)
- Drizzle configuration (drizzle.config.ts)
- Environment variables template (.env.example)
- npm scripts added: type-check, db:generate, db:migrate, db:push, db:studio
- Module queries and actions implemented:
  - auth module (queries.ts, actions.ts)
  - workspace module (queries.ts, actions.ts)
  - content module (queries.ts, actions.ts)
  - git module (queries.ts, actions.ts)
  - logseq module (types.ts)
- README.md updated with project overview and setup instructions
- **Phase 1 Complete**: Authentication & Basic UI
  - Session management with iron-session (lib/session.ts)
  - Login page (/login) with form action
  - Signup page (/signup) with workspace creation
  - Dashboard layout with nav and logout
  - Dashboard page showing workspace + git status
  - Landing page with hero, features, how-it-works
  - Middleware for protected routes
  - Session actions (login, signup, logout)
- Next.js configuration updated (disabled cacheComponents temporarily for auth)
- Database client allows build without DATABASE_URL (warns instead of erroring)
- **Phase 2 Complete**: Git Integration
  - Settings page for repository connection (/dashboard/settings)
  - GitHub repository connection form (URL, branch, token)
  - Git clone logic using shell commands (modules/git/clone.ts)
  - Repository sync system (modules/git/sync.ts)
  - GitHub webhook endpoint (/api/webhooks/github)
  - Manual deployment trigger button
  - Background sync on repository connection
  - Deployment history tracking
  - Error logging and status display
- **Git Sync Improvements**:
  - Auto-detection of default branch (getDefaultBranch function)
  - Branch validation before clone (validateBranch function)
  - Improved error messages (auth failed, repo not found, branch mismatch)
  - Security guide for GitHub Personal Access Tokens (README.md#github-personal-access-token-setup)
  - Settings page links to PAT security guide
  - Branch auto-detection message in settings UI
- **Account Management**:
  - Danger zone in settings page for account deletion
  - Username confirmation required for deletion
  - Cascading deletes (workspace, repos, nodes, deployment history)
  - Session destruction and redirect on account deletion
- **Phase 3 Complete**: Logseq Processing
  - Storage module with S3-compatible abstraction (modules/storage/)
  - S3 client for MinIO (local) and AWS S3 (prod)
  - Asset upload functionality for images/attachments
  - **Proper export-logseq-notes integration** (inspired by dimfeld/website):
    - Template file for HTML output with metadata (title, tags, dates)
    - Comprehensive TOML configuration with Tailwind-compatible CSS classes
    - Rhai script for page processing and custom HTML attributes
    - Template specified in config (fixes "no default template" error)
  - Rust tool integration (modules/logseq/export.ts)
  - Shell execution wrapper for export-logseq-notes CLI
  - HTML output parser with metadata extraction (modules/logseq/parse.ts)
  - Meta tag parsing (title, tags, created/updated dates)
  - Body content extraction (strips HTML wrapper)
  - LogseqPage to NewNode conversion
  - Namespace extraction and depth calculation
  - Journal page detection (YYYY_MM_DD pattern)
  - Asset processing in HTML (upload to S3, replace refs)
  - Content ingestion action (modules/content/actions.ts)
  - ingestLogseqGraph() server action
  - Batch node insertion with idempotent deletes
  - Sync pipeline integration (modules/git/sync.ts)
  - Deployment build logs tracking
  - AWS SDK client-s3 dependency added
  - Environment variables for S3 configuration
  - Last error timestamp in settings UI
  - **Export Configuration Features**:
    - Tag collection with omit list
    - Link handling with base URL
    - Code syntax highlighting with class prefix
    - Em dash conversion
    - Header promotion (h1 → h2, etc.)
    - Block and page embeds support
    - Custom wrapper elements and CSS classes via block attributes
- **Setup Scripts Module**:
  - Automated setup scripts in scripts/ directory
  - install-rust-tools.sh (Rust + export-logseq-notes + CARGO_BIN_PATH config)
  - setup-minio.sh (MinIO Docker container + bucket)
  - setup-database.sh (Drizzle schema push)
  - setup.sh (master script, runs all steps)
  - SCRIPTS.md documentation with troubleshooting
  - All scripts idempotent, Unix-compatible, error-safe
- **Shell Execution Utilities**:
  - lib/shell.ts module for Next.js server execution
  - execWithPath() - Execute commands with extended PATH
  - findBinary() - Locate binaries in common locations
  - binaryExists() - Fast binary existence check
  - Fixes "command not found" errors in Next.js server environment
  - All execAsync usages migrated to execWithPath
- **Phase 4 Complete**: Public Viewer
  - Public viewer routing (app/[workspaceSlug]/[...path]/page.tsx)
  - Workspace layout with sticky header (app/[workspaceSlug]/layout.tsx)
  - Workspace index page with auto-redirect to first content
  - Server-side rendering of pre-compiled HTML
  - **Navigation Components** (components/viewer/):
    - Sidebar with hierarchical tree navigation
    - Breadcrumbs for nested page hierarchy
    - Active page highlighting
    - Journal pages section (10 most recent)
  - **Content Rendering**:
    - NodeContent component with Tailwind prose styling
    - Comprehensive typography classes (headings, links, code, blockquotes)
    - Tag display on pages (#hashtag style)
    - Responsive layout with max-width constraints
  - **Performance Optimizations**:
    - Experimental PPR (Partial Pre-rendering) enabled
    - React cache for all queries (workspace, nodes, breadcrumbs)
    - Optimized database queries with proper indexes
  - **User Experience**:
    - Empty state for workspaces without content
    - 404 handling for missing workspaces and nodes
    - Mobile-responsive sidebar and content
    - Clean, minimal design inspired by modern documentation sites
- **Phase 5 Complete**: Deployment Pipeline & Polish
  - **Performance & Caching**:
    - Added "use cache" directive to all content queries
    - React cache for optimal query performance
    - Cache invalidation prepared for deployments
  - **Loading States**:
    - Workspace loading skeleton (app/[workspaceSlug]/loading.tsx)
    - Node page loading skeleton (app/[workspaceSlug]/[...path]/loading.tsx)
    - Animated skeleton screens for better UX
  - **Deployment Pipeline**:
    - Deployment logs already tracked in deployment_history table
    - Build logs stored with each deployment
    - Automatic cache invalidation on successful deployment
    - Console logging for deployment status
- **Logseq Block-Level Integration** (Complete Revamp):
  - **Database Schema Evolution**:
    - Added parentId to nodes table (self-referential foreign key for hierarchy)
    - Added order field (block ordering within siblings)
    - Added nodeType field ('page' | 'block' discriminator)
    - Added blockUuid field (Logseq block UUID from id:: property)
    - Pages have html=null, blocks have rendered HTML
    - Composite indexes for (parentId, order) and (blockUuid)
  - **Markdown Parser** (modules/logseq/markdown-parser.ts):
    - Parses Logseq .md files to extract block structure
    - Extracts block UUIDs from id:: properties
    - Builds parent-child relationships from indentation
    - Flattens block tree for database insertion
    - Preserves block order and hierarchy
  - **Block HTML Rendering**:
    - Uses `marked` library for markdown to HTML conversion
    - Renders each block's markdown independently
    - Preserves formatting (bold, italic, links, code, lists)
    - Simple, reliable, and maintainable approach
  - **Rust Tool Integration**:
    - Forked export-logseq-notes to modules/logseq/export-tool/
    - Vendored as part of codebase (removed .git directory)
    - Built and installed to ~/.cargo/bin/ (108MB release binary)
    - Updated dependencies (cargo update) to fix time crate compatibility
    - Tool used for page-level metadata extraction only
  - **Sync Integration** (modules/content/actions.ts):
    - ingestLogseqGraph() creates both page and block nodes
    - Step 1: Parse markdown for block structure (hierarchy + UUIDs)
    - Step 2: Run Rust tool for page metadata
    - Step 3: Create page nodes (html=null)
    - Step 4: Create block nodes with markdown-rendered HTML
    - Step 5: Update parentId for proper block→block and block→page relationships
    - Step 6: Recalculate depth from actual parent chain in database
    - **Critical Fix**: Blocks now properly linked to parent blocks, not all to page
    - **Critical Fix**: Depth calculated from database parent chain, not markdown structure
  - **BlockTree UI Component** (components/viewer/BlockTree.tsx):
    - Client-side React component for Logseq-style block tree
    - Clickable bullets for navigation (navigate to block via #hash)
    - Collapsible blocks (click bullet with children to expand/collapse)
    - Recursive rendering of block hierarchy
    - Block state management with useState
    - Links to blocks via blockUuid hash
  - **Logseq-Style CSS** (app/blocks.css):
    - Hover effects on blocks (gray-100 background)
    - Bullet point hover effects (blue-500 color, scale transform)
    - Target block highlighting (:target with yellow-100 background)
    - Smooth animations and transitions
    - Indentation for nested blocks
  - **Query Layer**:
    - getAllBlocksForPage() query (modules/content/queries.ts)
    - Fetches all blocks for a page by pageName
    - Ordered by order field
    - Cached with "use cache" directive
  - **Page Viewer Integration**:
    - app/[workspaceSlug]/[...path]/page.tsx now fetches blocks
    - Renders BlockTree if blocks exist
    - Shows "No blocks yet" if empty
    - blocks.css imported in layout.tsx

### Changed
- README Quick Start now references automated scripts
- Documentation order prioritizes SCRIPTS.md
- Landing page completely redesigned with Vercel-style UI
- App directory structure expanded with auth and dashboard route groups
- Git repository connection triggers initial sync automatically
- Git clone now validates branch exists before attempting clone
- Settings page placeholder updated from "ghp_..." to "github_pat_..." for fine-grained tokens
- **Auto-correction behavior**: Git sync now automatically detects and uses default branch if specified branch doesn't exist, then persists correct branch (no manual user intervention required per CRUD guidelines)
- **Block HTML rendering approach**: Switched from HTML parsing to direct markdown rendering with `marked` library (simpler, more reliable)
- **Content storage model**: Pages now have html=null (blocks contain the content), following true Logseq architecture
- **Block hierarchy**: Fixed to use proper block→block parent relationships instead of all blocks pointing to page
- **Depth calculation**: Now calculated from actual database parent chain instead of markdown structure

### Deprecated
- N/A

### Removed
- modules/logseq/extract-blocks.ts (HTML extraction module - replaced with markdown rendering)
- node-html-parser dependency (no longer needed)
- backend-services/export-logseq-notes (git submodule - replaced with vendored copy in modules/)

### Fixed
- Removed `revalidateTag` from sync function (was causing "used during render" error)
- **Next.js 16 uncached data errors**: Wrapped ALL async params access in Suspense (cacheComponents compatible)
  - **Critical pattern**: `await params` MUST happen inside Suspense, not before
  - Dashboard page: DashboardContent wrapper inside Suspense
  - Dashboard layout: DashboardLayoutContent wrapper inside Suspense (requireAuth → cookies)
  - Workspace layout: WorkspaceLayoutWrapper inside Suspense (await params)
  - Workspace index: WorkspaceIndexWrapper inside Suspense (await params)
  - Node page: NodePageWrapper inside Suspense (await params)
  - All routes now use Partial Prerender (◐) with proper streaming
- **cacheComponents compatibility**: Replaced `dynamic = "force-dynamic"` with proper Suspense pattern
- **Build failures (Google Fonts)**: Removed Geist/Geist_Mono fonts (network errors), using system fonts
- **Block hierarchy broken (all depth 0)**: Fixed parentId assignment to use block→block relationships, not all→page
- **Block depth incorrect**: Now calculated from actual database parent chain after parentId is set
- **Block HTML not showing**: Switched from fragile HTML parsing to direct markdown rendering with `marked`
- **Performance: N+1 query problem in depth calculation**:
  - Replaced recursive DB queries with in-memory calculation (calculateBlockDepthInMemory)
  - Built parentIdMap and pageIds Set during parentId updates
  - Eliminated individual DB query per block (was causing slow page loads)
  - modules/content/actions.ts: calculateBlockDepthFromParents removed
- **Performance: Missing database index**:
  - Added workspacePageNameNodeTypeIdx index on (workspaceId, pageName, nodeType)
  - Optimizes getAllBlocksForPage query (common read path)
- **BlockTree duplication bug**:
  - Fixed getChildBlocks receiving subset instead of all blocks
  - Removed double-match condition (parentId OR blockUuid)
  - Fixed top-level detection to properly find page node
  - components/viewer/BlockTree.tsx rewritten with simpler logic
- **Query optimization**:
  - getAllNodes now filters nodeType='page' (was returning ALL nodes including blocks)
  - getJournalNodes now filters nodeType='page' (was returning blocks)
  - getAllBlocksForPage now returns page node + blocks (BlockTree needs page node)
  - Sidebar navigation no longer processes thousands of individual blocks
- **Block ID mapping broken (blocks not displaying)**:
  - Root cause: Blocks without explicit `id::` property have uuid=null
  - Previous code skipped blocks without UUIDs when setting parentId
  - Fix: Map blocks by position in insertion order (pageBlocksMap)
  - Blocks without UUIDs now correctly linked to parents via indent level
  - modules/content/actions.ts: Enhanced parentId mapping (lines 218-315)
- Status badges (idle/syncing/success/error) now update in real-time when user refreshes page
- Removed `revalidatePath` from async promise handlers to prevent render errors
- Renamed middleware.ts to proxy.ts (Next.js 16 convention)
- export-logseq-notes installation (builds from GitHub source, not crates.io)
- Rust time crate compilation (auto-updates to stable toolchain)
- Docker group missing (creates group on Linux before adding user)
- Docker permission denied (auto-detects, adds user to docker group)
- All bash scripts rewritten with cleanup traps (prevent broken state)
- SCRIPTS.md updated with comprehensive troubleshooting
- BASH_GUIDELINES.md added with industry best practices
- setup-minio.sh Docker permissions refactored to use helper functions with proper error handling
- BASH_GUIDELINES.md Docker pattern updated with complete error handling and platform detection
- **Phase 3: Shell execution in Next.js server** - Fixed "export-logseq-notes not found" error
- **Phase 3: Template error** - Fixed "Config has no default template" error by adding proper template file to TOML config
- **Phase 3: Metadata extraction** - Now properly extracts tags, dates, and title from HTML meta tags
- **Phase 3: Configuration** - Comprehensive TOML config with all export-logseq-notes options (inspired by dimfeld/website best practices)
  - Node.js doesn't inherit shell PATH, cargo bin directory not accessible
  - Created lib/shell.ts with execWithPath() and findBinary() utilities
  - All shell commands now use extended PATH (cargo, git, user binaries)
  - install-rust-tools.sh now configures CARGO_BIN_PATH in .env.local
  - .env.example updated with CARGO_BIN_PATH=$HOME/.cargo/bin
  - BASH_GUIDELINES.md updated with "Next.js Server Execution Pattern" section
  - Covers development, production, CI/CD PATH issues
  - modules/logseq/export.ts migrated to shell utilities
  - modules/git/clone.ts migrated to shell utilities (all execAsync calls)
- **Phase 3: export-logseq-notes configuration** - Fixed TOML config format errors
  - Tool outputs HTML files to directory, not JSON to stdout
  - Fixed config: `template` expects file path string, not TOML table (`[template]` syntax error)
  - Fixed config: `script` field is required - created minimal Rhai script to include all pages
  - Updated export.ts to use proper config format (data, product, output, script, extension)
  - Created minimal .draehi-script.rhai that includes all pages without filtering
  - Updated parse.ts to read HTML files from output directory instead of JSON parsing
  - Decodes URL-encoded filenames (e.g., "some%20page.html" → "some page")
  - modules/content/actions.ts updated to use outputDir instead of output string
  - Cleanup both config and script files after execution

### Security
- N/A

---

## [0.1.0] - 2025-11-16

### Added
- Initial Next.js project setup
- ESLint configuration
- Turbopack support
- Basic app directory structure

---

**Version Format:** [MAJOR.MINOR.PATCH]
- MAJOR: Breaking changes
- MINOR: New features, backward compatible
- PATCH: Bug fixes, backward compatible

**Last Updated:** 2025-11-16
